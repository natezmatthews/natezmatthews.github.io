<!DOCTYPE html>
<html>
<head>
<title>Future Perfect</title>
<meta charset="utf-8"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="../ics.js/ics.min.js"></script>
<script src="../ics.js/ics.deps.min.js"></script>
<link rel="stylesheet" type="text/css" href="calstyle.css">
<link href='https://fonts.googleapis.com/css?family=Alegreya+Sans' rel='stylesheet' type='text/css'>
<script type="text/javascript">
    var line = '<div id="finaldiv">\n<input type="button" value="X" onclick="kill(this)" />\n<textarea class="name" rows="1" style="width: 26.5em" onchange="newline(value)" onfocus="this.select()"></textarea>\n<textarea class="date" rows="1" style="width: 10em" onfocus="this.select()"></textarea></div>'
    var cal = ics();
    var events_obj = null;

    var LifeEvents = function() {
        this.arr = []
        this.res = []
    };

    LifeEvents.prototype.resetevents = function(){
        this.arr = []
        this.res = []
    };

    LifeEvents.prototype.getinput = function(){
        var array = this.arr;
        var allvalid = true;
        $(".name").each(function(i) {
            val = $(this).val();
            if (val != "") {
                var item = {daname:"",dadate:0};
                item.daname = val;
                array[i] = item;
            }
        });

        $(".date").each(function(i) {
            val = $(this).val();
            if (val != "") {
                newdate = new Date(val);
                if (newdate == "Invalid Date" && val != "MM/DD/YYYY") {
                    $(this).val("Invalid Date").addClass("invalid").attr("onfocus","clr()");
                    allvalid = false;
                }
                array[i].dadate = newdate;
            }
        });
        this.arr = array.sort(function(obj1,obj2) {
            return obj1.dadate - obj2.dadate;
        });;
        return allvalid;
    };

    LifeEvents.prototype.makeoutput = function(){
        var array = this.arr;
        var results = this.res;
        for (var i = 0; i < array.length; i++) {
            for (var j = 0; j < array.length; j++) {
                if (i >= j) {continue;}
                var odate = new Date((array[j].dadate - array[i].dadate) * 2 + array[i].dadate.getTime());
                var date = (odate.getMonth() + 1).toString() + '/' + odate.getDate().toString() + '/' + odate.getFullYear().toString();
                var item = {namea:array[i].daname, nameb:array[j].daname, datestr:date, odate:odate}
                results.push(item);
            }
        };
        
        results.sort(function(obj1,obj2) {
            return obj2.odate - obj1.odate;
        });

        this.res = results;
        console.log(this.res);
    };

    LifeEvents.prototype.updatepage = function(){
        $("#finaldiv").after("<div class ='resultsmsgs'><br><span>To add these to your calendar, select the events you want,</span><br><span> click 'Export' below, and then import that file to your calendar program.</span><br>");
        $("#finaldiv").hide();
        var btn = $("#done");
        btn.attr("value","Reset");
        btn.attr("onclick","reset()");
        $.each(this.res, function(i,item) {
            var tense = (item.odate < (new Date())) ? 'it had been':'it will have been';
            $("#finaldiv").after('<div class ="resultsmsgs"><br><input type="checkbox" id="c' + i + '" checked>&nbsp&nbsp<span>On ' + item.datestr + ' ' + tense + ' twice as long since ' + item.namea + ' as since ' + item.nameb + '.</span><br></div>');
        });
        $("#download").show();
    };

    LifeEvents.prototype.downloadics = function(){
        $.each(this.res, function(i,item) {
            if ($("#c" + i).is(":checked")) {
                var name = item.nameb + ' bisects ' + item.namea + ' and now';
                var desc = 'It has been now twice as long since \"' + item.namea + '\" as since \"' + item.nameb + '\".';
                cal.addEvent(name,desc,'',item.datestr,item.datestr);
            }
        });
        cal.download();
    };

    LifeEvents.prototype.printarr = function(){
        console.log(this.arr);
    };

    function kill(btn) {
        victim = $(btn).parent();
        if (victim.attr("id") == "finaldiv") {
            victim.after(line);
        }
        victim.remove();
    }

    function newline(val) {
        if (val == "") return;
        $("#done").removeAttr("disabled");
        dis = $("#finaldiv");
        dis.removeAttr("id");
        fields = $('[onchange="newline(value)"]');
        fields.removeAttr("onchange");
        dis.after(line);
    }

    function clr() {
        dis = $(document.activeElement);
        dis.removeAttr("id");
        dis.attr("onfocus","this.select()");
        dis.removeClass("fresh");
        if (dis.val() == "Name of Event" || dis.val() == "MM/DD/YYYY") {
            dis.val("");
        }
        if (dis.val() == "Invalid Date") {
            dis.val("");
            dis.removeClass("invalid");
        }
    }

    function start() {
        $("#finaldiv > textarea").addClass("fresh");
        events_obj = new LifeEvents();
    }

    function calc() {
        // console.log(events_obj);
        if(events_obj.getinput()) {
            events_obj.makeoutput();
            events_obj.updatepage();
            return true;
        } else {
            return false;
        }
        // console.log(fillsuc);
        // events_obj.printarr();
    }

    function download() {
        events_obj.downloadics();
        // $.each(res, function(i,item) {
        //     if ($("#c" + i).is(":checked")) {
        //         var name = item.nameb + ' bisects ' + item.namea + ' and now';
        //         var desc = 'It has been now twice as long since \"' + item.namea + '\" as since \"' + item.nameb + '\".';
        //         cal.addEvent(name,desc,'',item.datestr,item.datestr);
        //     }
        // });
        // cal.download();
    }

    function reset() {
        events_obj.resetevents();
        $(".resultsmsgs").remove();
        $("#finaldiv").show();
        var btn = $("#done");
        btn.attr("value","Done");
        btn.attr("onclick","calc()");
        $("#download").hide();
    }
</script>

</head>

<body onload="start()">

<h1>Future Perfect</h1>

<div id="block">

<br>

<span>This website will tell you on what date it will have been twice as long<br>since one event in your life as since another. For example:</span>


<div id="example">"On 11/17/2029 it will have been twice as long since you<br> were born as since you graduated from highschool."</div>

<span>Enter the names and dates of significant events in your life below:</span>

<br><br>

<div id="finaldiv">
<input type="button" value="X" onclick="kill(this)" />
<textarea class="name" rows="1" style="width: 26.5em" onchange="newline(value)" onfocus="clr()">Name of Event</textarea>
<textarea class="date" rows="1" style="width: 10em" onchange="newline(value)" onfocus="clr()">MM/DD/YYYY</textarea>
</div>

<br>

<input type="button" id="done" value="Done" onclick="calc()" disabled/>
&nbsp;
<input type="button" id="download" style="display:none;" value="Export" onclick="download()" />

<br><br>

</div>

<div id="credits">

<span>Website by Nate Matthews</span><br>
<span>Background logo "Calendar" by <a href="https://thenounproject.com/edward/">Edward Boatman</a> from the Noun Project</span><br>
<span>ICS file creation by <a href="https://github.com/nwcell">Travis Krause</a></span><br>

</div>

</body>
</html>












